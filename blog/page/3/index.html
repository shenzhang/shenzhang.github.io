
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>章显魅颖</title>
  <meta name="author" content="zshen">

  
  <meta name="description" content="原文链接 Hotspot JVM 1.6具有三种类型的锁，当你试图使用java.util.concurrent.locks.Lock的实现去获取一个锁，或者进入一个synchronized块时就会使用JVM提供的锁： biased锁(偏向锁) 在有些时候，就算时在一个并发环境中， &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://shenzhang.github.io/blog/page/3">
  <link href="/favicon.jpeg" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Keep going" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Keep going</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:shenzhang.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/08/14/how-to-implement-lock-in-jvm/">JVM是如何实现锁[译]</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-08-14T01:27:00+10:00" pubdate data-updated="true">Aug 14<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://slava-technical.blogspot.de/2011/04/how-does-jvm-handle-locks.html">原文链接</a></p>

<p>Hotspot JVM 1.6具有三种类型的锁，当你试图使用java.util.concurrent.locks.Lock的实现去获取一个锁，或者进入一个synchronized块时就会使用JVM提供的锁：</p>

<h2>biased锁(偏向锁)</h2>

<p>在有些时候，就算时在一个并发环境中，实际上对于某些对象来说时没有真正的竞争的，这个时候jvm就不会向操作系统申请互斥对象(mutex)来实现锁。Hotspot可以使用一些内部的数据结构来更加高效的模拟锁。比如，一段被synchronized包裹的同步代码在当前并没有并发的执行，JVM就会使用CAS来将当前拥有锁的线程ID赋给一个用来表示互斥对象的对象中，并且如果CAS成功的话还会将重入次数也存进去。这个就是偏向锁，JVM最轻量级的锁。重入次数这个变量会被锁的当前拥有线程更新，就像更新一个局部变量一样，不会使用CAS。如果CAS失败，说明该锁当前正被其他线程拥有，这个时候JVM会暂停该互斥对象的拥有线程，将线程上下文刷新的主存中，并检查重入次数。如果重入次数时0，那么JVM就会将该锁升级为thin，否则就升级为fat。Hotspot使用互斥对象中的同样的域(field)来存储锁的拥有者线程ID</p>

<h2>thin锁</h2>

<p>这个实际上是一个简单的自旋锁。如果自旋的时间很短的话，它可以班组节约线程切换的时间（不立刻阻塞并且发生切换，而是先自旋一段时间）。当一个线程试图获取一个已经被占用的锁，那么该线程会先自旋一段时间，直到这个锁被释放。自旋的次数由内部的jvm实现决定，通常会考虑以下因素：JVM对当前应用所搜集的一些统计信息；当前线程数；CPU使用情况和数量等等。当自旋失败后，JVM决定将该thin锁升级为fat锁</p>

<h2>fat锁</h2>

<p>JVM中最高级别的锁，底层会向操作系统申请系统级别的互斥对象，并且使用操作系统的调度器来对线程进行挂起和恢复。这种类型的锁的开销比前面提到的锁要大得多，因为每次锁的释放和获取都会使得JVM与底层操作系统进行互操作。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/08/14/garbage-collection-in-hotspot/">Hotspot JVM中的垃圾收集器[译]</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-08-14T01:27:00+10:00" pubdate data-updated="true">Aug 14<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://blog.ragozin.info/2011/12/garbage-collection-in-hotspot-jvm.html">原文连接</a>，该文和我的<a href="/blog/2013/07/23/gc-in-hotspot">这篇文章</a>非常非常类似，纯属巧合。另外也可以看看<a href="http://hllvm.group.iteye.com/group/topic/38223#post-248757">这篇文章</a>对不同垃圾算法的描述。</p>

<p>Hotspot拥有好几种GC模式，具体采用那种模式可以通过命令行选项来指定。默认的GC模式由JVM的版本，client/server模式，以及当前的硬件条件来决定。</p>

<h2>串行GC（Serial GC)</h2>

<p>JVM开关：-XX:+UseSerialGC</p>

<p>串行GC是一种分代垃圾搜集算法（实际上现在的Hotspot虚拟机中的所有垃圾手机算法都是分代手机算法）。在新生代采用了拷贝算法，老年代采用了标记-整理(mark-sweep-compact MSC)算法。老年代和新生代在垃圾手机的时候都会发生STW，并且就行它的名称一样，所有手机操作都是在单个线程里完成。在老年代的垃圾收集中，所有存活的对象会被移动到空间的开始处，这样就可以让JVM将不使用的内存区域交还给操作系统。</p>

<p>如果你使用<code>-XX:+PrintGCDeitals</code>开启了GC log，你就可以看到如下输出：</p>

<p>新生代：</p>

<pre><code>41.614 [GC 41.614: [DefNew: 130716K-&gt;7953K(138240K), 0.0525908 secs] 890546K-&gt;771614K(906240K), 0.0527947 secs] [Times: user=0.05 sys=0.00, real=0.05 secs]
</code></pre>

<p>Full GC（新生代 + 老年代 + 永久区）：</p>

<pre><code>41.908 [GC 41.908: [DefNew: 130833K-&gt;130833K(138240K), 0.0000257 secs]41.909: [Tenured: 763660K-&gt;648667K(768000K), 1.4323505 secs] 894494K-&gt;648667K(906240K), [Perm : 1850K-&gt;1850K(12288K)], 1.4326801 secs] [Times: user=1.42 sys=0.00, real=1.43 secs]
</code></pre>

<h2>并行清除</h2>

<p>JVM开关:<code>-XX:+UseParallelGC</code></p>

<p>垃圾搜集的某些阶段本身就可以具有并行化的特点。并行处理可以减少GC和STW暂停需要的时间，并且可以充分利用多核CPU。现代VM中采用并行GC来有效利用多核硬件已经显得非常有必要了。并行GC在新生代中采用了并行的算法，老年代仍然采用的是单线程的Mark-Sweep-Compact算法。因此，采用该模式将会减少新生代的GC暂停时间，但是对于full gc的时间还是比较长的。</p>

<p>gc log如下：
新生代：</p>

<pre><code>59.821: [GC [PSYoungGen: 147904K-&gt;4783K(148288K)] 907842K-&gt;769258K(916288K), 0.2382801 secs] [Times: user=0.31 sys=0.00, real=0.24 secs]
</code></pre>

<p>老年代：</p>

<pre><code>60.060: [Full GC [PSYoungGen: 4783K-&gt;0K(148288K)] [PSOldGen: 764475K-&gt;660316K(768000K)] 769258K-&gt;660316K(916288K) [PSPermGen: 1850K-&gt;1850K(12288K)], 1.2817061 secs] [Times: user=1.26 sys=0.00, real=1.28 secs]
</code></pre>

<h2>老年代并行GC算法</h2>

<p>JVM开关:<code>-XX:+UseParallelOldGC</code></p>

<p>该模式是在并行清除模式基础上做的增量改进。它在老年代添加了并行化的Mark-Sweep-Compact算法，新生代还是采用并行清除里的并行算法。老年代仍然会产生较长的STW暂停，但是对多核处理器的利用可以让这个时间减少一些。不像串行MSC算法，并行的版本不会在堆的末尾产生一片连续的空闲内存区域（存活的对象都被移动到了区域的开始处），因此JVM无法将未用的区域归还给操作系统。</p>

<p>gc log如下：</p>

<p>新生代：</p>

<pre><code>65.411: [GC [PSYoungGen: 147878K-&gt;5434K(144576K)] 908129K-&gt;770314K(912576K), 0.2734699 secs] [Times: user=0.41 sys=0.00, real=0.27 secs]
</code></pre>

<p>full gc:</p>

<pre><code>65.411: [GC [PSYoungGen: 147878K-&gt;5434K(144576K)] 908129K-&gt;770314K(912576K), 0.2734699 secs] [Times: user=0.41 sys=0.00, real=0.27 secs]
</code></pre>

<h2>自适应策略</h2>

<p>JVM开关：<code>-XX:+UseAdaptiveSizePolicy</code></p>

<p>这个是在并行清除模式下的一种特殊模式，它可以动态调整新生代的大小以适应当前应用程序的特点。实际上它不会带来显著的性能提升，因此不要随便使用该选项。</p>

<h2>并行标记清除算法(CMS)</h2>

<p>JVM开关：<code>-XX:+UseConcMarkSweepGC</code></p>

<p>前面介绍的gc收集器通常被称为最大吞吐量收集器。CMS收集器是一种低暂停率的收集器，它被设计来减少STW暂停，并且提高应用程序的响应性。对于新生代可以采用串行的拷贝算法或者并行算法（该并行算法和前面介绍的并行搜集中的新生代并行算法有点类似，但是它们实际上是两套不同的实现代码，并且它们可能会使用不同的配置选项，比如自适应策略在CMS中就不存在）。</p>

<p>老年代采用了并发的搜集方法。就像名字所言，CMS是一种标记-清除算法（没有整理[compact]过程）。CMS在每个搜集周期内只需要两个很短暂的暂停，但是不像标记-整理算法，CMS不会做内存整理操作（将内存对象重新布局）并且会导致产生内存碎片。虽然CMS算法采用了一些手段来尽量克服内存碎片，但是这还是一个潜在的问题。</p>

<p>如果这种并发的收集器不能很快速的为应用程序分配内存，JVM还是会退化到使用串行的STW mark-sweep-compact（标记整理算法）来对老年代进行碎片整理（使用串行化的MSC算法的停顿时间往往是CMS停顿时间的50-500倍）。</p>

<p>gc log如下：</p>

<p>新生代：</p>

<pre><code>613.154: [GC 13.154: [DefNew: 130821K-&gt;8230K(138240K), 0.0507238 secs] 507428K-&gt;388797K(906240K), 0.0509611 secs] [Times: user=0.06 sys=0.00, real=0.05 secs]
</code></pre>

<p>老年代：</p>

<pre><code>13.433: [GC [1 CMS-initial-mark: 384529K(768000K)] 395044K(906240K), 0.0045952 secs] [Times: user=0.02 sys=0.00, real=0.01 secs]
13.438: [CMS-concurrent-mark-start]
...
14.345: [CMS-concurrent-mark: 0.412/0.907 secs] [Times: user=1.20 sys=0.00, real=0.91 secs]
14.345: [CMS-concurrent-preclean-start]
14.366: [CMS-concurrent-preclean: 0.020/0.021 secs] [Times: user=0.03 sys=0.00, real=0.02 secs]
14.366: [CMS-concurrent-abortable-preclean-start]
...
14.707: [CMS-concurrent-abortable-preclean: 0.064/0.340 secs] [Times: user=0.36 sys=0.02, real=0.34 secs]
14.707: [GC[YG occupancy: 77441 K (138240 K)]14.708: [Rescan (non-parallel) 14.708: [grey object rescan, 0.0058016 secs]14.714: [root rescan, 0.0424011 secs], 0.0485593 secs]14.756: [weak refs processing, 0.0000109 secs] [1 CMS-remark: 404346K(768000K)] 481787K(906240K), 0.0487607 secs] [Times: user=0.05 sys=0.00, real=0.05 secs]
14.756: [CMS-concurrent-sweep-start]
...
14.927: [CMS-concurrent-sweep: 0.116/0.171 secs] [Times: user=0.23 sys=0.02, real=0.17 secs]
14.927: [CMS-concurrent-reset-start]
14.953: [CMS-concurrent-reset: 0.026/0.026 secs] [Times: user=0.05 sys=0.00, real=0.03 secs]
</code></pre>

<h2>当CMS后分配失败并且退化到MSC算法时</h2>

<pre><code>557.079: [GC 557.079: [DefNew557.097: [CMS-concurrent-abortable-preclean: 0.010/0.109 secs] [Times: user=0.12 sys=0.00, real=0.11 secs]
 (promotion failed) : 130817K-&gt;130813K(138240K), 0.1401674 secs]557.219: [CMS (concurrent mode failure): 731771K-&gt;584338K(768000K), 2.4659665 secs] 858916K-&gt;584338K(906240K), [CMS Perm : 1841K-&gt;1835K(12288K)], 2.6065527 secs] [Times: user=2.48 sys=0.03, real=2.61 secs]
</code></pre>

<h2>CMS增量模式</h2>

<p>JVM开关：<code>-XX:+CMSIncrementalMode</code></p>

<p>CMS使用一个或多个后台线程并且与应用程序线程并发的执行gc操作。这些线程会和应用程序线程竞争CPU时间。增量模式下会对gc后台线程占用的cpu时间做限制，如果只有1个或2个cpu核心，那么这会进一步提高应用程序的响应性。当然，老年代的搜集可能会变得更长，并且发生full gc的风险会更高。</p>

<h2>G1收集算法</h2>

<p>JVM开关：<code>-XX:+UseG1GC</code></p>

<p>G1(garbage first)是Hotspot中新设计的垃圾搜集器。它在jdk1.6的较新版本中本引入。G1是一种低停顿的算法，并且采用了mark-sweep-compact的改进增量型算法。G1将堆划分为大小固定的多个区域，并且可以在STW暂停中对其中的部分区域进行垃圾搜集（与CMS不同，G1大部分的工作需要在STW中运行）。增量式可以用多个短暂停代替少量的长暂停（多个短暂停的总和还是会远远大于CMS）。更精确的说，G1会采用多个后台线程与应用程序并发的运行，来对堆中的内存进行标记(mark)（与CMS类似），但是还是有大量的工作是在STW中执行。</p>

<p>G1在对其中的部分区域进行搜集时还是会采用拷贝算法，这样在每次搜集完成后会产生一些空闲的区域，它们可以被JVM在适当的时候归还给操作系统。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/08/13/serial-paiallel-cms-in-hotspot/">Hotspot的垃圾回收：串行、并行和CMS[译]</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-08-13T01:27:00+10:00" pubdate data-updated="true">Aug 13<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://www.tikalk.com/java/garbage-collection-serial-vs-parallel-vs-concurrent-mark-sweep">原文链接</a></p>

<p>串行(Serial)，并行(Parallel)和CMS（Concurrent-Mark-Sweep)垃圾搜集算法到底有什么不同呢？</p>

<p>首先，让我们看看哪些算法是用于新生代，哪些算法是用于老年代：</p>

<h3>以下算法用于新生代：</h3>

<pre><code>-XX:+UseSerialGC 
-XX:+UseParallelGC 
-XX:+UseParNewGC
</code></pre>

<h3>以下算法用于老年代:</h3>

<pre><code>-XX:+UseParallelOldGC 
-XX:+UseConcMarkSweepGC
</code></pre>

<h3>串行和并行收集器有什么不同</h3>

<p>串行和并行垃圾收集器在GC的时候都会造成Stop-The-World，串行收集器默认是一个拷贝算法，并且使用单个线程来完成GC操作；并行收集器采用多个线程完成GC操作。</p>

<h3>并行收集器和CMS有什么不同</h3>

<p>CMS会通过以下步骤（所有步骤都使用一个线程完成）</p>

<ol>
<li>inital mark</li>
<li>concurrent marking</li>
<li>remark</li>
<li>concurrent sweeping</li>
</ol>


<p><em>主要有两点不同：</em></p>

<ol>
<li>并行收集器使用多个线程，CMS只使用单个线程</li>
<li>并行收集器会Stop-The-World，但是CMS仅仅在inital mark和remark阶段会STW,concrrent marking和concurrent sweeping阶段时，GC线程会和应用程序线程并发运行。</li>
</ol>


<h3>如果你想将GC定制化为并行化和并发化，那么可以使用下面的参数:</h3>

<pre><code>-XX:UserParNewGC：让新生代使用多个线程
-XX:+UseConcMarkSweepGC:在老年代使用CMS（一个线程，仅仅在inital mark和remark阶段才发生STW)
</code></pre>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/08/13/safepoints-in-hotspot/">Hotspot中的safepoints[译]</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-08-13T01:27:00+10:00" pubdate data-updated="true">Aug 13<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://blog.ragozin.info/2012/10/safepoints-in-hotspot-jvm.html">原文链接</a></p>

<p>术语Stop-The-World(STW)通常和垃圾搜集相关。虽然GC是STW暂停的最主要原因，但并不是唯一的原因。</p>

<h2>Safepoints</h2>

<p>在Hotspot虚拟机中Stop-The-World暂停机制被称作safepoint。在safepoint期间，所有运行java代码的线程都会被挂起。运行本地代码的线程都会继续执行，直到与JVM进行交互（比如调用java的方法或者从本地代码返回到java代码）。</p>

<p>在暂停所有的线程时，要求safepoint的发起者具有JVM数据的排他访问权限，这样就可以做很多疯狂的事情，比如在堆中移动数据或者替换正在运行的方法中的代码。</p>

<h2>Safepoint是怎么工作的？</h2>

<p>Hotspot JVM中的safepoint是一种协作性的协议。所有的应用程序线程会检查safepoint的状态，当需要进入safepoint的时候，线程会暂停自己并且保持在一个安全的状态下。</p>

<p>对于已经被编译的代码（JIT编译），JIT编译器会在某些代码点插入safepoint检查代码（一般是在调用返回的时候或者是循环退出的时候）。对于解释执行的代码，JVM有两个字节码分发表(byte code dispatch table)，当需要进入safepoint的时候，JVM会在这两个表之间切换以便做safepoint检查。</p>

<p>safepoint状态检查实现的非常巧妙，普通的内存变量检查需要内存屏障的支持。safepoint检查以读取内存屏障的方式实现。当需要safepoint的时候，JVM取消对应用程序线程中导致页错误的地址映射（由JVM直接处理）。这样，Hotspot可以让经过JIT编译的代码保持CPU流水线的友好性，同时也保证了正确的内存语义。</p>

<h2>什么时候会触发safepoints</h2>

<p>下面是Hotspot JVM中会触发safepoints的一些原因：</p>

<ol>
<li>垃圾回收</li>
<li>代码优化</li>
<li>刷新缓存</li>
<li>类重定义(比如hotswap或者instrumentation)</li>
<li>撤销偏向锁</li>
<li>多种调试操作(比如死锁检查，运行栈dump)</li>
</ol>


<h2>safepoints问题排查</h2>

<p>通常情况下safepoints会经常存在并一直工作者，因此你并不需要怎么关系它（大多数情况下，除了GC，都非常快速和短暂）。如果由于偶然的因素破坏了safepoint的正常工作，就会让事情变得很糟，因此下面是一些有用的诊断方法：</p>

<ol>
<li><p><code>-XX:+PrintGCApplicationStoppedTime</code>:该选项会报告所有safepoints的暂停时间（与GC相关的或者不相关的）。但是不幸的是，这个选项的输出缺少时间戳信息，但是它仍然可以帮助定位问题。</p></li>
<li><p><code>-XX:+PrintSafepointStatistics和-XX:PrintSafepointStatisticsCount=1</code>:这两个选项会强制JVM在safepoint后报告发生safepoint的原因及耗时（仅会输出到stdout，不会输出到GC日志(log)里）</p></li>
</ol>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/08/12/timeout-in-different-browser/">不同浏览器支持的最小时间精度</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-08-12T01:27:00+10:00" pubdate data-updated="true">Aug 12<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>最近在实现一个灵活的div滚动条方案，主要用于解决windows下滚动条的美化问题，以及IE下对滚动条位置计算的不足。其中需要对div的内容大小进行持续监视，找了一个jquery的mutate插件，但是该插件的代码实在不敢恭维，于是对其进行了一些优化，减少了很多不必要的jquery对象创建过程。</p>

<p>该插件的原理非常简单，直接使用的setTimeout对检测属性进行监控，并且时间间隔是1ms，最初担心性能问题，但是发现实际上由于浏览器对时间的精度不会很高(不到1ms)，因此没有什么影响。但是还是对各浏览器的精度做了个简单测试,代码很简单：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">begin</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="kd">function</span> <span class="nx">test</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">begin</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">begin</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">();</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  
</span><span class='line'>  <span class="nx">count</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="nx">count</span> <span class="o">==</span> <span class="mi">1000</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">((</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">()</span> <span class="o">-</span> <span class="nx">begin</span><span class="p">)</span> <span class="o">/</span> <span class="nx">count</span><span class="p">);</span>
</span><span class='line'>      <span class="k">return</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">test</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nx">$</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">test</span><span class="p">();</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>最后的结果为：</p>

<pre><code>chrome: 4-5ms
firefox: 5-6ms
ie: 15ms
</code></pre>

<p>因此，最后将检测间隔设置成了50，既可以避免潜在的性能问题，也不会影响表现效果。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/08/05/fist-view-of-zookeeper/">初识zookeeper</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-08-05T01:27:00+10:00" pubdate data-updated="true">Aug 5<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>zookeeper是apache基金会下的一个高可用的分布式数据管理和协调框架，它最初也是hadoop下的一个子项目被用于hadoop生态系统中，但是随着被大家的不断挖掘，zookeeper有了更广泛的应用(应用场景可以参见<a href="http://rdc.taobao.com/team/jm/archives/1232">这里</a>).</p>

<h2>如何搭建单机版的zookeeper服务</h2>

<p>1.下载zookeeper</p>

<p>2.创建配置文件conf/zoo.cfg，并加入下面的配置信息：</p>

<pre><code>tickTime=2000
dataDir=/var/lib/zookeeper
clientPort=2181
</code></pre>

<p>完整的配置参数请参见<a href="http://zookeeper.apache.org/doc/current/zookeeperAdmin.html#sc_configuration">官方文档</a>.</p>

<p>3.启动zookeeper服务</p>

<pre><code>bin/zkServer.sh start
</code></pre>

<h2>测试</h2>

<p>可以直接使用bin/zkCli.sh这个脚本提供的java客户端来进行测试，该脚本的内容也非常简单:</p>

<ol>
<li>执行zkEnv.sh设置环境变量</li>
<li>执行org.apache.zookeeper.ZooKeeperMain</li>
</ol>


<p><code>bin/zkCli.sh -server host:port</code>来启动客户端，或者直接使用zkCli.sh来连接localhost:2181，连接上后可以使用help命令来查看所有客户端支持的命令：</p>

<pre><code>connect host:port
get path [watch]
ls path [watch]
set path data [version]
rmr path
delquota [-n|-b] path
quit
printwatches on|off
create [-s] [-e] path data acl
stat path [watch]
close
ls2 path [watch]
history
listquota path
setAcl path acl
getAcl path
sync path
redo cmdno
addauth scheme auth
delete path [version]
setquota -n|-b val path
</code></pre>

<p>例如：</p>

<ol>
<li>查看根路径: ls /</li>
<li>创建一个znode(节点): create /fish helloworld</li>
<li>查看一个节点: get /fish</li>
<li>重新设置一个节点的内容: set /fish hello</li>
</ol>


<h2>关闭zookeeper</h2>

<pre><code>bin/zkServer.sh stop
</code></pre>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/07/27/inspect-jndi/">JNDI环境初始化深入分析</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-07-27T05:27:00+10:00" pubdate data-updated="true">Jul 27<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>JNDI是什么</h2>

<p>jndi: Java Naming and Directory Interface</p>

<p>jndi是j2ee提供的用于对象查找和获取的接口规范，该规范需要j2ee容器去实现以提供jndi的功能，不同的容器或者说jndi实现者对jndi里的对象的注册方式和内部管理方式都不完全一样，但是获取方式都完全一样（jndi规定了怎么获取）,如：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">InitalContext</span> <span class="n">context</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InitialContext</span><span class="o">();</span>
</span><span class='line'><span class="n">Object</span> <span class="n">yourObject</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">lookup</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>当然jndi中还包含了LDAP等更高层次的接口规范，这里不进行描述。</p>

<h2>JNDI中可用的环境变量</h2>

<p>JNDI中预定义了一些环境变量，这些环境变量可以控制JNDI环境的行为（包括初始化过程），变量的定义在javax.naming.Context接口中，对应的javadoc有对各变量的说明，但是如果不看源码很难准确理解这些变量的意义。下面的片段截取了一些变量：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">String</span> <span class="n">INITIAL_CONTEXT_FACTORY</span> <span class="o">=</span> <span class="s">&quot;java.naming.factory.initial&quot;</span><span class="o">;</span>
</span><span class='line'><span class="n">String</span> <span class="n">OBJECT_FACTORIES</span> <span class="o">=</span> <span class="s">&quot;java.naming.factory.object&quot;</span><span class="o">;</span>
</span><span class='line'><span class="n">String</span> <span class="n">URL_PKG_PREFIXES</span> <span class="o">=</span> <span class="s">&quot;java.naming.factory.url.pkgs&quot;</span><span class="o">;</span>
</span><span class='line'><span class="n">String</span> <span class="n">APPLET</span> <span class="o">=</span> <span class="s">&quot;java.naming.applet&quot;</span><span class="o">;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>InitalContext</h2>

<p>javax.naming.InitalContext是客户端使用jndi的入口，也是jndi容器初始化的入口，因此jndi容器(环境)的初始化是lazy的，只有到需要的时候才会进行初始化。InitalContext的构造函数有两个：</p>

<p>1.不接受任何初始化环境变量</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="nf">InitialContext</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">NamingException</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">init</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>2.主动设置初始化环境变量(就是在上一节提到的环境变量)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="nf">InitialContext</span><span class="o">(</span><span class="n">Hashtable</span><span class="o">&lt;?,?&gt;</span> <span class="n">environment</span><span class="o">)</span><span class="kd">throws</span> <span class="n">NamingException</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">environment</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">environment</span> <span class="o">=</span> <span class="o">(</span><span class="n">Hashtable</span><span class="o">)</span><span class="n">environment</span><span class="o">.</span><span class="na">clone</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="n">init</span><span class="o">(</span><span class="n">environment</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>接下来会调用init函数来初始化InitalContext.defaultInitCtx变量，该变量也是Context类型，并且由具体的容器来实现，它才是真正的实现者。待defaultInitCtx创建好之后，InitalContext的所有操作就会被分发给defaultInitCtx执行，InitalContext本质上讲就是defaultInitCtx的工厂和代理。</p>

<h2>初始化过程</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="n">Hashtable</span><span class="o">&lt;?,?&gt;</span> <span class="n">environment</span><span class="o">)</span><span class="kd">throws</span> <span class="n">NamingException</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">myProps</span> <span class="o">=</span> <span class="n">ResourceManager</span><span class="o">.</span><span class="na">getInitialEnvironment</span><span class="o">(</span><span class="n">environment</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">myProps</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">INITIAL_CONTEXT_FACTORY</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="c1">// user has specified initial context factory; try to get it</span>
</span><span class='line'>        <span class="n">getDefaultInitCtx</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="n">Hashtable</span> <span class="nf">getInitialEnvironment</span><span class="o">(</span><span class="n">Hashtable</span> <span class="n">env</span><span class="o">)</span>
</span><span class='line'>        <span class="kd">throws</span> <span class="n">NamingException</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="n">String</span><span class="o">[]</span> <span class="n">props</span> <span class="o">=</span> <span class="n">VersionHelper</span><span class="o">.</span><span class="na">PROPS</span><span class="o">;</span>   <span class="c1">// system/applet properties</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">env</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">env</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Hashtable</span><span class="o">(</span><span class="mi">11</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="n">Object</span> <span class="n">applet</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">APPLET</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Merge property values from env param, applet params, and system</span>
</span><span class='line'>    <span class="c1">// properties.  The first value wins:  there&#39;s no concatenation of</span>
</span><span class='line'>    <span class="c1">// colon-separated lists.</span>
</span><span class='line'>    <span class="c1">// Read system properties by first trying System.getProperties(),</span>
</span><span class='line'>    <span class="c1">// and then trying System.getProperty() if that fails.  The former</span>
</span><span class='line'>    <span class="c1">// is more efficient due to fewer permission checks.</span>
</span><span class='line'>    <span class="n">String</span><span class="o">[]</span> <span class="n">jndiSysProps</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="na">getJndiProperties</span><span class="o">();</span>
</span><span class='line'>    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">props</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">Object</span> <span class="n">val</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">props</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">val</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">applet</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">val</span> <span class="o">=</span> <span class="n">AppletParameter</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">applet</span><span class="o">,</span> <span class="n">props</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">val</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="c1">// Read system property.</span>
</span><span class='line'>                <span class="n">val</span> <span class="o">=</span> <span class="o">(</span><span class="n">jndiSysProps</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
</span><span class='line'>                    <span class="o">?</span> <span class="n">jndiSysProps</span><span class="o">[</span><span class="n">i</span><span class="o">]</span>
</span><span class='line'>                    <span class="o">:</span> <span class="n">helper</span><span class="o">.</span><span class="na">getJndiProperty</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">val</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">env</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">props</span><span class="o">[</span><span class="n">i</span><span class="o">],</span> <span class="n">val</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Merge the above with the values read from all application</span>
</span><span class='line'>    <span class="c1">// resource files.  Colon-separated lists are concatenated.</span>
</span><span class='line'>    <span class="n">mergeTables</span><span class="o">(</span><span class="n">env</span><span class="o">,</span> <span class="n">getApplicationResources</span><span class="o">());</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">env</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这个函数实际上就是从一些环境变量（参数）源搜集jndi需要的环境变量，然后再以map的形式返回。</p>

<ol>
<li>InitalContext(environment)构造函数传递的环境变量。</li>
<li>如果a中指定了javax.naming.applet对象，则转换为Applet对象，这个Applet对象也成了源(applet)</li>
<li>System.getProperties()提供的环境变量(systemProperties)</li>
<li>应用程序提供的环境变量(application)。</li>
</ol>


<p>这些环境变量的优先级如下：2和3只能够提供以下的环境变量，其他的变量将被忽略：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">final</span> <span class="kd">static</span> <span class="n">String</span><span class="o">[]</span> <span class="n">PROPS</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="o">[]</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">javax</span><span class="o">.</span><span class="na">naming</span><span class="o">.</span><span class="na">Context</span><span class="o">.</span><span class="na">INITIAL_CONTEXT_FACTORY</span><span class="o">,</span>
</span><span class='line'>    <span class="n">javax</span><span class="o">.</span><span class="na">naming</span><span class="o">.</span><span class="na">Context</span><span class="o">.</span><span class="na">OBJECT_FACTORIES</span><span class="o">,</span>
</span><span class='line'>    <span class="n">javax</span><span class="o">.</span><span class="na">naming</span><span class="o">.</span><span class="na">Context</span><span class="o">.</span><span class="na">URL_PKG_PREFIXES</span><span class="o">,</span>
</span><span class='line'>    <span class="n">javax</span><span class="o">.</span><span class="na">naming</span><span class="o">.</span><span class="na">Context</span><span class="o">.</span><span class="na">STATE_FACTORIES</span><span class="o">,</span>
</span><span class='line'>    <span class="n">javax</span><span class="o">.</span><span class="na">naming</span><span class="o">.</span><span class="na">Context</span><span class="o">.</span><span class="na">PROVIDER_URL</span><span class="o">,</span>
</span><span class='line'>    <span class="n">javax</span><span class="o">.</span><span class="na">naming</span><span class="o">.</span><span class="na">Context</span><span class="o">.</span><span class="na">DNS_URL</span><span class="o">,</span>
</span><span class='line'>    <span class="c1">// The following shouldn&#39;t create a runtime dependence on ldap package.</span>
</span><span class='line'>    <span class="n">javax</span><span class="o">.</span><span class="na">naming</span><span class="o">.</span><span class="na">ldap</span><span class="o">.</span><span class="na">LdapContext</span><span class="o">.</span><span class="na">CONTROL_FACTORIES</span>
</span><span class='line'><span class="o">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>优先级是environment > applet > systemProperties</p>

<p>最后的env会和application（应用指定的）环境变量合并（如果env没有提供就采用application的，如果env有了，那么就会和application的合并，用逗号分割），如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">mergeTables</span><span class="o">(</span><span class="n">Hashtable</span> <span class="n">props1</span><span class="o">,</span> <span class="n">Hashtable</span> <span class="n">props2</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">Enumeration</span> <span class="n">keys</span> <span class="o">=</span> <span class="n">props2</span><span class="o">.</span><span class="na">keys</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">while</span> <span class="o">(</span><span class="n">keys</span><span class="o">.</span><span class="na">hasMoreElements</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">String</span> <span class="n">prop</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span><span class="n">keys</span><span class="o">.</span><span class="na">nextElement</span><span class="o">();</span>
</span><span class='line'>        <span class="n">Object</span> <span class="n">val1</span> <span class="o">=</span> <span class="n">props1</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">prop</span><span class="o">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">val1</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">props1</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">prop</span><span class="o">,</span> <span class="n">props2</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">prop</span><span class="o">));</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">isListProperty</span><span class="o">(</span><span class="n">prop</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">String</span> <span class="n">val2</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span><span class="n">props2</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">prop</span><span class="o">);</span>
</span><span class='line'>            <span class="n">props1</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">prop</span><span class="o">,</span> <span class="o">((</span><span class="n">String</span><span class="o">)</span><span class="n">val1</span><span class="o">)</span> <span class="o">+</span> <span class="s">&quot;:&quot;</span> <span class="o">+</span> <span class="n">val2</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>最后来看下怎么获取application(应用级别)的环境变量:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="kd">static</span> <span class="n">Hashtable</span> <span class="nf">getApplicationResources</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">NamingException</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">ClassLoader</span> <span class="n">cl</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="na">getContextClassLoader</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">propertiesCache</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">Hashtable</span> <span class="n">result</span> <span class="o">=</span> <span class="o">(</span><span class="n">Hashtable</span><span class="o">)</span><span class="n">propertiesCache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">cl</span><span class="o">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">NamingEnumeration</span> <span class="n">resources</span> <span class="o">=</span>
</span><span class='line'>                <span class="n">helper</span><span class="o">.</span><span class="na">getResources</span><span class="o">(</span><span class="n">cl</span><span class="o">,</span> <span class="n">APP_RESOURCE_FILE_NAME</span><span class="o">);</span>
</span><span class='line'>            <span class="k">while</span> <span class="o">(</span><span class="n">resources</span><span class="o">.</span><span class="na">hasMore</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">Properties</span> <span class="n">props</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Properties</span><span class="o">();</span>
</span><span class='line'>                <span class="n">props</span><span class="o">.</span><span class="na">load</span><span class="o">((</span><span class="n">InputStream</span><span class="o">)</span><span class="n">resources</span><span class="o">.</span><span class="na">next</span><span class="o">());</span>
</span><span class='line'>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                    <span class="n">result</span> <span class="o">=</span> <span class="n">props</span><span class="o">;</span>
</span><span class='line'>                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>                    <span class="n">mergeTables</span><span class="o">(</span><span class="n">result</span><span class="o">,</span> <span class="n">props</span><span class="o">);</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// Merge in properties from file in &lt;java.home&gt;/lib.</span>
</span><span class='line'>            <span class="n">InputStream</span> <span class="n">istream</span> <span class="o">=</span>
</span><span class='line'>                <span class="n">helper</span><span class="o">.</span><span class="na">getJavaHomeLibStream</span><span class="o">(</span><span class="n">JRELIB_PROPERTY_FILE_NAME</span><span class="o">);</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">istream</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">Properties</span> <span class="n">props</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Properties</span><span class="o">();</span>
</span><span class='line'>                <span class="n">props</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="n">istream</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                    <span class="n">result</span> <span class="o">=</span> <span class="n">props</span><span class="o">;</span>
</span><span class='line'>                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>                    <span class="n">mergeTables</span><span class="o">(</span><span class="n">result</span><span class="o">,</span> <span class="n">props</span><span class="o">);</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">NamingException</span> <span class="n">ne</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ConfigurationException</span><span class="o">(</span>
</span><span class='line'>                    <span class="s">&quot;Error reading application resource file&quot;</span><span class="o">);</span>
</span><span class='line'>            <span class="n">ne</span><span class="o">.</span><span class="na">setRootCause</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span><span class='line'>            <span class="k">throw</span> <span class="n">ne</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Hashtable</span><span class="o">(</span><span class="mi">11</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="n">propertiesCache</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">cl</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>实际上就是使用当前线程的ContextClassLoader去尝试加载两个peropery形式的配置文件：</p>

<ol>
<li>APP_RESOURCE_FILE = jndi.properties</li>
<li>&lt;java.home>/lib/jndi.properties</li>
</ol>


<p>这个步骤对于某些jndi容器来说是相当重要的，因为前面提到了环境变量指定方式都需要应用做额外的配置或者写特定的代码，这个步骤就可以让容器的实现者可以将自己的配置放在约定的配置文件里，供jndi使用。比如jetty8的jndi容器实现就是通过<code>classpath://jndi.properties</code>来做配置的:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">java</span><span class="o">.</span><span class="na">naming</span><span class="o">.</span><span class="na">factory</span><span class="o">.</span><span class="na">url</span><span class="o">.</span><span class="na">pkgs</span><span class="o">=</span><span class="n">org</span><span class="o">.</span><span class="na">eclipse</span><span class="o">.</span><span class="na">jetty</span><span class="o">.</span><span class="na">jndi</span>
</span><span class='line'><span class="n">java</span><span class="o">.</span><span class="na">naming</span><span class="o">.</span><span class="na">factory</span><span class="o">.</span><span class="na">initial</span><span class="o">=</span><span class="n">org</span><span class="o">.</span><span class="na">eclipse</span><span class="o">.</span><span class="na">jetty</span><span class="o">.</span><span class="na">jndi</span><span class="o">.</span><span class="na">InitialContextFactory</span>
</span></code></pre></td></tr></table></div></figure>


<p>之前有个朋友问他的jetty中的应用为什么InitalContext.lookup总是报错，配置不对。实际上就是没有将jetty-jndi-[version].jar依赖进来，这个里面就包含了jndi.properties的配置文件，除非使用jetty-all.jar的集合包，否则要想让jetty提供jndi的功能就一定需要该jar包。</p>

<p>好了通过上面的分析，最后搜集到了所有的环境变量的值，并保存在InitialContext.myProps中，继续初始化defaultInitCtx&hellip;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="n">Hashtable</span><span class="o">&lt;?,?&gt;</span> <span class="n">environment</span><span class="o">)</span><span class="kd">throws</span> <span class="n">NamingException</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">myProps</span> <span class="o">=</span> <span class="n">ResourceManager</span><span class="o">.</span><span class="na">getInitialEnvironment</span><span class="o">(</span><span class="n">environment</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">myProps</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">INITIAL_CONTEXT_FACTORY</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="c1">// user has specified initial context factory; try to get it</span>
</span><span class='line'>        <span class="n">getDefaultInitCtx</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>如果环境变量里指明了INITAL_CONTEXT_FACTORY(java.naming.factory.inital)就开始初始化默认的Context:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">protected</span> <span class="n">Context</span> <span class="nf">getDefaultInitCtx</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">NamingException</span><span class="o">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(!</span><span class="n">gotDefault</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">defaultInitCtx</span> <span class="o">=</span> <span class="n">NamingManager</span><span class="o">.</span><span class="na">getInitialContext</span><span class="o">(</span><span class="n">myProps</span><span class="o">);</span>
</span><span class='line'>        <span class="n">gotDefault</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">defaultInitCtx</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
</span><span class='line'>        <span class="k">throw</span> <span class="k">new</span> <span class="nf">NoInitialContextException</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">defaultInitCtx</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="n">Context</span> <span class="nf">getInitialContext</span><span class="o">(</span><span class="n">Hashtable</span><span class="o">&lt;?,?&gt;</span> <span class="n">env</span><span class="o">)</span>
</span><span class='line'>    <span class="kd">throws</span> <span class="n">NamingException</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">InitialContextFactory</span> <span class="n">factory</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">InitialContextFactoryBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">getInitialContextFactoryBuilder</span><span class="o">();</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">builder</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="c1">// No factory installed, use property</span>
</span><span class='line'>        <span class="c1">// Get initial context factory class name</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">String</span> <span class="n">className</span> <span class="o">=</span> <span class="n">env</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span>
</span><span class='line'>            <span class="o">(</span><span class="n">String</span><span class="o">)</span><span class="n">env</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">INITIAL_CONTEXT_FACTORY</span><span class="o">)</span> <span class="o">:</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">className</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">NoInitialContextException</span> <span class="n">ne</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NoInitialContextException</span><span class="o">(</span>
</span><span class='line'>                <span class="s">&quot;Need to specify class name in environment or system &quot;</span> <span class="o">+</span>
</span><span class='line'>                <span class="s">&quot;property, or as an applet parameter, or in an &quot;</span> <span class="o">+</span>
</span><span class='line'>                <span class="s">&quot;application resource file:  &quot;</span> <span class="o">+</span>
</span><span class='line'>                <span class="n">Context</span><span class="o">.</span><span class="na">INITIAL_CONTEXT_FACTORY</span><span class="o">);</span>
</span><span class='line'>            <span class="k">throw</span> <span class="n">ne</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">factory</span> <span class="o">=</span> <span class="o">(</span><span class="n">InitialContextFactory</span><span class="o">)</span>
</span><span class='line'>                <span class="n">helper</span><span class="o">.</span><span class="na">loadClass</span><span class="o">(</span><span class="n">className</span><span class="o">).</span><span class="na">newInstance</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">catch</span><span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">NoInitialContextException</span> <span class="n">ne</span> <span class="o">=</span>
</span><span class='line'>                <span class="k">new</span> <span class="nf">NoInitialContextException</span><span class="o">(</span>
</span><span class='line'>                    <span class="s">&quot;Cannot instantiate class: &quot;</span> <span class="o">+</span> <span class="n">className</span><span class="o">);</span>
</span><span class='line'>            <span class="n">ne</span><span class="o">.</span><span class="na">setRootCause</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span><span class='line'>            <span class="k">throw</span> <span class="n">ne</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">factory</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">createInitialContextFactory</span><span class="o">(</span><span class="n">env</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">factory</span><span class="o">.</span><span class="na">getInitialContext</span><span class="o">(</span><span class="n">env</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>可以看出创建Context的过程实际上是一个工厂模式，要先找到这个工厂(InitalContextFactory)</p>

<ol>
<li>首先检查NamingManager中是否配置的有IntialContextFactoryBuilder（Context工厂的工厂），如果有的话就用指定的factoryBuilder创建一个ContextFactory</li>
<li>否则就用环境变量里java.naming.factory.inital指定的工厂。</li>
<li>得到工厂后，就用这个工厂去创建这个defaultContext(InitalContext就是这个真正的Context的代理）。</li>
</ol>


<p>至于这个defaultContext是怎么实现的就依赖具体的容器了，只要符合jndi的规范就可以了，但是实际上规范中对这块的要求也是很少的，只是对一些概念和接口做了确定。</p>

<p>回头看来其实jndi的初始化是很简单的，就是简单的指定一些环境变量，特别是<code>INITAL_CONTEXT_FACTORY(java.naming.factory.inital)</code>参数，特工一个真正Context的工厂就行了，连创建的过程都交给具体容器去实现了。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/07/27/gziphandler-in-jetty/">Jetty常用handler之GzipHandler</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-07-27T04:27:00+10:00" pubdate data-updated="true">Jul 27<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><code>org.eclipse.jetty.server.handler.GzipHandler</code>提供了将response压缩成gzip格式的功能，该handler需要放在真正数据处理的handler(ServletHandler,ResourceHandler等)前面。</p>

<p>它的实现原理也非常简单，实际上是将HttpServletResponse进行了一个包装，在后续的handler需要OutputStream或Writer的时候返回一个被Gzip流包装过的OutputStream，以便在输出流的时候对数据流进行压缩。除此之外，它还对request请求头做了检查，如果client不支持gzip格式，那么就不会做包装，直接交给后续handler。</p>

<p>由于该handler通用性很强，因此也导致了它的效率不高，每次请求都需要做gzip压缩处理，没有任何缓存功能，服务端的开销会增大。如果使用了WebAppContext，那么该功能完全可以被DefaultServlet取代，DefaultServlet也会对client的gzip支持特性做检查，如果请求的是静态文件，DefaultServlet会优先检查是否存在.gz后缀的同名文件，有的话就直接用.gz文件进行返回，但是缺点是不支持动态响应的压缩功能。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/07/27/debughandler-in-jetty/">Jetty常用handler之DebugHandler</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-07-27T03:27:00+10:00" pubdate data-updated="true">Jul 27<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><code>org.eclipse.jetty.server.handler.DebugHandler</code>是一个内部逻辑非常简单的handler，主要用于输出调试信息，虽然doc中表示该handler可以用于生产环境，但是我觉得功能还是太简单，并且输出内容也不是很实用。</p>

<p>该handler主要被放置在handler链的头部，它会在请求开始处理的时候向指定的OutputStream输出当前时间以及请求路径等信息，并且在该request处理完成后输出当前时间，主要用于分析不同资源的请求处理时长。可以调用<code>DebugHandler.setOutputStream</code>来指定输出目的地。</p>

<p>显然这种将所有请求都进行输出的方式不但影响性能，同时对于大量的日志还需要专门的程序进行分析。更好的方式是直接设定输出阈值，处理时间超过了该阈值就进行输出，当然如果对于日志还有其他的分析目的就另当别论了，有点类似RequestLogHandler。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/07/27/defaulthandler-in-jetty/">Jetty常用handler之DefaultHandler</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-07-27T01:27:00+10:00" pubdate data-updated="true">Jul 27<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><code>org.eclipse.jetty.server.handler.DefaultHandler</code>，从名字就可以看出是jetty里的默认handler，之所以是默认不是Jetty预设的handler，而是说一般将该handler作为handler链的最后一个handler来处理请求。如果前面的handler都没能顺利处理请求(request.setHandled(true))，那么就让该handler来处理。</p>

<p>DefaultHandler提供了以下功能：</p>

<ol>
<li>如果请求的是/favicon.ico，那么就将jetty自己的icon图标返回给客户端。</li>
<li>如果请求的是/，那么就将当前jetty里所有的context根路径配合简单的html标签返回给客户端，比如说jetty提供了/app1和/app2两个引用，但是用户并不知道该server提供的应用的context，那么就可以直接输入/路径，DefaultHandler如果处理该请求就会用友好的方法告诉用户“当前的jetty提供了/app1和/app2两个引用”</li>
<li>其他情况一律返回404代码及对应的出错页面。</li>
</ol>


<p>其实自己看下上述三种功能，在实际应用中都不实用，最多开发阶段供调试使用。不过里面的代码还是值得一看的，既简单又反映了标准的handler编写模式。</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/4/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/2/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/09/19/spring-mvc-qa/">Spring MVC中的二三事</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/09/17/spring-binding-validation/">再谈Spring的Binding和Validation</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/08/28/what-does-mvc-annotation-driven-do/">Mvc:annotation-driven到底帮我们做了什么</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/08/17/inside-angular-source-1/">AngularJS源代码分析1</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/05/25/java8-invokedynamic/">深入分析invokeDynamic</a>
      </li>
    
  </ul>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - zshen -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
